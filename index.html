<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdownメモ</title>
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- XSS対策 -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  display: flex;
  height: 100vh;
}
#list {
  width: 35%;
  background: #eee;
  padding: 10px;
  overflow-y: auto;
}
#editor {
  width: 65%;
  padding: 10px;
  display: flex;
  flex-direction: column;
}
.item {
  background: #fff;
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 6px;
}
.item.active {
  background: #cde4ff;
}
textarea {
  height: 35%;
  font-size: 16px;
}
#preview {
  flex: 1;
  background: #fff;
  margin-top: 8px;
  padding: 10px;
  overflow: auto;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="list">
  <button id="add">＋ 新規メモ</button>
  <div id="items"></div>
</div>

<div id="editor">
  <textarea id="memo" placeholder="Markdown / Mermaid対応"></textarea>
  <div id="preview"></div>
</div>

<script>
/* ==========================
   Mermaid 初期化
   ========================== */
mermaid.initialize({
  startOnLoad: false,
  theme: "default",
  flowchart: { useMaxWidth: false }
});

/* ==========================
   Markdown設定
   ========================== */
marked.setOptions({
  breaks: true,
  mangle: false,
  headerIds: false
});

/* ==========================
   データ
   ========================== */
let memos = JSON.parse(localStorage.getItem("memos") || "[]");
let current = 0;

function save() {
  localStorage.setItem("memos", JSON.stringify(memos));
}

/* ==========================
   表示
   ========================== */
function renderList() {
  const items = document.getElementById("items");
  items.innerHTML = "";

  memos.forEach((memo, index) => {
    const div = document.createElement("div");
    div.className = "item" + (index === current ? " active" : "");
    div.textContent =
      memo.text.split("\n")[0].replace(/^#+\s*/, "") || "（無題）";
    div.onclick = () => {
      current = index;
      renderList();
      renderEditor();
    };
    items.appendChild(div);
  });
}

async function renderEditor() {
  const text = memos[current]?.text || "";
  document.getElementById("memo").value = text;

  // Markdown → HTML
  const rawHtml = marked.parse(text);
  const safeHtml = DOMPurify.sanitize(rawHtml);
  const preview = document.getElementById("preview");
  preview.innerHTML = safeHtml;

  // Mermaid再描画
  await mermaid.run({
    querySelector: "#preview"
  });
}

/* ==========================
   イベント
   ========================== */
document.getElementById("add").onclick = () => {
  memos.unshift({ text: "" });
  current = 0;
  save();
  renderList();
  renderEditor();
};

document.getElementById("memo").addEventListener("input", () => {
  memos[current].text = memo.value;
  save();
  renderList();
  renderEditor();
});

/* ==========================
   初期化
   ========================== */
if (memos.length === 0) {
  memos.push({ text: "" });
}
renderList();
renderEditor();
</script>

</body>
</html>
